# Cluster ETCD with Vagrant

## Prerequisite  

* Install Vagrant  
https://www.vagrantup.com/downloads.html

* Install Ansible  
https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#latest-releases-via-pip

```
sudo easy_install pip
sudo pip install ansible
```

* Install VirtualBox  
https://www.virtualbox.org/wiki/Downloads

##  Deploy etcd cluster 3 nodes  
 
*  Creation multiVM / multiInterface / Ansible  
https://fale.io/blog/2017/03/21/vagrant-etcd-cluster/
https://github.com/Fale/vagrant/tree/master/etcd/

```
mkdir demo-etcd
cd demo-etcd
wget https://github.com/Fale/vagrant/blob/master/etcd/Vagrantfile
wget https://github.com/Fale/vagrant/blob/master/etcd/etcd.conf
wget https://github.com/Fale/vagrant/blob/master/etcd/setup.yaml
```

`vagrant up ` 

* Ensure SSH connexion to each node of cluster

```
vagrant ssh etcd0 ... etcd1 ... etcd 2
```


##  Ensure ETCD is working  
https://coreos.com/etcd/docs/latest/getting-started-with-etcd.html

* Ensure unitary Test  
```
etcdctl --endpoint http://192.168.60.10:2379 set /message Hello  
hello
etcdctl --endpoint http://192.168.60.10:2379 get /message  
hello 
```

* Ensure all cluster ETCD is working 
 
  * Loop on node 1 to modify value /message to "Hello $date"

`for (( i=0 ; $i <= 15 ; i++ )); do etcdctl --endpoint http://$(ip addr show eth1 | grep -Po 'inet \K[\d.]+'):2379 set /message "hello --> $(date)"; sleep 1 ; done  `
  
  * * Loop on node 2 to read value /message
`while true; do etcdctl --endpoint http://$(ip addr show eth1 | grep -Po 'inet \K[\d.]+'):2379 get /message ; sleep 1 ; done `
  
  * * Loop on node 2 to read value /message 
`while true; do etcdctl --endpoint http://$(ip addr show eth1 | grep -Po 'inet \K[\d.]+'):2379 get /message ; sleep 1 ; done  `


# Sync Vagrant folde
* Synchronisation one time /vagrant
vagrant rsync

* * Synchronisation en boucle /vagrant
vagrant rsync-auto

# Annexes

## PlaybookYum.yml

`
ansible-playbook PlaybookYum.yml -i vagrant_ansible_inventory
`

* PlaybookYum.yml 

```
- name: manage etcd
  hosts: <localhost ou host>
  become: true
  tasks:
    - name: etcd
      etcd3:
        key: ansible1
        value: "Hello"
        host: 192.168.60.10
        port: 2379
        state: present
      register: result

    - name: debug
      debug:
        var: result


* vagrant_ansible_inventory

```
# Generated by Vagrant
etcd2 ansible_host=127.0.0.1 ansible_port=2201 ansible_user='vagrant' ansible_ssh_private_key_file='/Users/lcolagio/vagrant/etcd-test/.vagrant/machines/etcd2/virtualbox/private_key'
etcd1 ansible_host=127.0.0.1 ansible_port=2200 ansible_user='vagrant' ansible_ssh_private_key_file='/Users/lcolagio/vagrant/etcd-test/.vagrant/machines/etcd1/virtualbox/private_key'
etcd0 ansible_host=127.0.0.1 ansible_port=2222 ansible_user
```

